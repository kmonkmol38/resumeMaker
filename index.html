<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resume Maker by ALI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Merriweather:wght@400;700&family=Montserrat:wght@400;700&family=Open+Sans:wght@400;700&family=Roboto:wght@400;700&family=Source+Sans+Pro:wght@400;700&family=Playfair+Display:wght@400;700&family=Poppins:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" integrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>
        :root {
            --primary-color: #2563eb;
            --font-family: 'Roboto', sans-serif;
        }
        body {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        #resume-preview {
            font-family: var(--font-family);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease-in-out;
            aspect-ratio: 210 / 297; /* A4 Paper aspect ratio */
            color: var(--text-color, #333333);
        }
        .sidebar {
            scrollbar-width: thin;
            scrollbar-color: var(--primary-color) #e5e7eb;
        }
        .sidebar::-webkit-scrollbar {
            width: 8px;
        }
        .sidebar::-webkit-scrollbar-track {
            background: #e5e7eb;
        }
        .sidebar::-webkit-scrollbar-thumb {
            background-color: var(--primary-color);
            border-radius: 10px;
            border: 2px solid #e5e7eb;
        }
        .theme-card, .template-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .theme-card:hover, .template-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .theme-card.selected, .template-card.selected {
            box-shadow: 0 0 0 3px var(--primary-color);
            transform: translateY(-2px);
        }
        .rating-stars .star {
            cursor: pointer;
            color: #d1d5db; /* gray-400 */
            transition: color 0.2s;
        }
        .rating-stars .star:hover,
        .rating-stars .star.selected {
            color: #f59e0b; /* amber-500 */
        }
        @media print {
            body * {
                visibility: hidden;
            }
            #resume-preview, #resume-preview * {
                visibility: visible;
            }
            #resume-preview {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                margin: 0;
                box-shadow: none;
                border: none;
            }
            .no-print {
                display: none !important;
            }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <div id="app" class="flex flex-col md:flex-row h-screen">
        <!-- Sidebar - Form -->
        <aside class="sidebar w-full md:w-1/2 lg:w-1/3 bg-white p-6 overflow-y-auto no-print">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">ALI's Resume Maker</h1>
            
            <!-- Customization Panel -->
            <div class="bg-gray-50 p-4 rounded-lg mb-6">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Customize</h2>
                
                <!-- CV Template -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-600 mb-2">CV Template</label>
                    <div id="template-selector" class="grid grid-cols-3 gap-3"></div>
                </div>

                <!-- Theme Selector -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-600 mb-2">Color Theme</label>
                    <div id="theme-selector" class="grid grid-cols-3 md:grid-cols-4 gap-3"></div>
                </div>

                <!-- Font Selector -->
                <div class="mb-4">
                    <label for="font-select" class="block text-sm font-medium text-gray-600">Font Style</label>
                    <select id="font-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md"></select>
                </div>
                
                <!-- Custom Styles -->
                <div id="custom-styles-panel" class="bg-white p-4 rounded-lg border border-gray-200 mt-4">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Custom Styles</h3>
                    <div class="space-y-4">
                        <div>
                            <label for="text-color-picker" class="block text-sm font-medium text-gray-600">Text Color</label>
                            <input type="color" id="text-color-picker" data-style="textColor" class="mt-1 block w-full h-10 p-1 border border-gray-300 rounded-md cursor-pointer">
                        </div>
                        <div>
                            <label for="highlight-color-picker" class="block text-sm font-medium text-gray-600">Highlight Color</label>
                            <input type="color" id="highlight-color-picker" data-style="highlightColor" class="mt-1 block w-full h-10 p-1 border border-gray-300 rounded-md cursor-pointer">
                        </div>
                        <div>
                            <label for="font-size-name" class="flex justify-between text-sm font-medium text-gray-600">Name Size <span id="font-size-name-value" class="font-bold"></span></label>
                            <input type="range" id="font-size-name" data-style="fontSizeName" min="24" max="48" step="1" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                        </div>
                         <div>
                            <label for="font-size-title" class="flex justify-between text-sm font-medium text-gray-600">Title Size <span id="font-size-title-value" class="font-bold"></span></label>
                            <input type="range" id="font-size-title" data-style="fontSizeTitle" min="16" max="32" step="1" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                        </div>
                         <div>
                            <label for="font-size-section-title" class="flex justify-between text-sm font-medium text-gray-600">Section Title Size <span id="font-size-section-title-value" class="font-bold"></span></label>
                            <input type="range" id="font-size-section-title" data-style="fontSizeSectionTitle" min="14" max="24" step="1" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                        </div>
                         <div>
                            <label for="font-size-body" class="flex justify-between text-sm font-medium text-gray-600">Body Text Size <span id="font-size-body-value" class="font-bold"></span></label>
                            <input type="range" id="font-size-body" data-style="fontSizeBody" min="9" max="14" step="1" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                        </div>
                    </div>
                </div>

                <div class="mt-4">
                    <button id="download-pdf-btn" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700 transition duration-300">Download PDF</button>
                </div>
            </div>

            <!-- Form Sections -->
            <form id="resume-form" class="space-y-6">
                <!-- Personal Info -->
                <div class="bg-white p-4 rounded-lg border border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Personal Info</h3>
                    <div class="grid grid-cols-1 gap-4">
                        <div class="flex items-center space-x-4">
                            <img id="photo-preview" class="h-16 w-16 rounded-full object-cover bg-gray-200" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iI0U1RTdFQiI+PHBhdGggZmlsbC1ydWxlPSJldmVub2RkIiBkPSJNMTguNjg1IDE5LjA5N0E5LjcyMyA5LjcyMyAwIDAgMCAyMS43NSAxMmMwLTUuMzg1LTQuMzY1LTkuNzUtOS43NS05Ljc1UzIuMjUgNi42MTUgMi4yNSAxMmE5LjcyMyA5LjcyMyAwIDAgMCAzLjA2NSA3LjA5N0E5LjcxNiA5LjcxNiAwIDAgMCAxMiAyMS43NWE5LjcxNiA5LjcxNiAwIDAgMCA2LjY4NS0yLjY1M1ptLTEyLjU0LTEuMjg1QTcuNDg2IDcuNDg2IDAgMCAxIDEyIDE1YTcuNDg2IDcuNDg2IDAgMCAxIDUuODU1IDIuODEyQTguMjI0IDguMjI0IDAgMCAxIDEyIDIwLjI1YTguMjI0IDguMjI0IDAgMCAxLTUuODU1LTIuNDM4Wk0xNS43NSA5YTMuNzUgMy43NSAwIDEgMS03LjUgMCAzLjc1IDMuNzUgMCAwIDEgNy41IDBaIiBjbGlwLXJ1bGU9ImV2ZW5vZGQiIC8+PC9zdmc+" alt="Profile photo">
                            <label for="photo" class="cursor-pointer bg-white py-2 px-3 border border-gray-300 rounded-md shadow-sm text-sm leading-4 font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                <span>Upload Photo</span>
                                <input id="photo" name="photo" type="file" class="sr-only" accept="image/*">
                            </label>
                        </div>
                        <input type="text" id="name" placeholder="Full Name" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <input type="text" id="jobTitle" placeholder="Job Title" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <input type="text" id="phone" placeholder="Phone" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <input type="email" id="email" placeholder="Email" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <input type="text" id="address" placeholder="Address" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <input type="text" id="linkedin" placeholder="LinkedIn Profile URL" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <input type="text" id="github" placeholder="GitHub Profile URL" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <input type="text" id="portfolio" placeholder="Portfolio/Website URL" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>

                <!-- Professional Summary -->
                <div class="bg-white p-4 rounded-lg border border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Professional Summary</h3>
                    <textarea id="summary" placeholder="Write a brief summary about your professional background..." class="w-full h-24 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                </div>

                <!-- Work Experience -->
                <div class="bg-white p-4 rounded-lg border border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Work Experience</h3>
                    <div id="experience-list" class="space-y-4"></div>
                    <button type="button" id="add-experience" class="mt-4 w-full text-blue-600 font-semibold py-2 px-4 border-2 border-dashed border-blue-300 rounded-md hover:bg-blue-50 transition duration-300">Add Experience</button>
                </div>

                <!-- Education -->
                <div class="bg-white p-4 rounded-lg border border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Education</h3>
                    <div id="education-list" class="space-y-4"></div>
                    <button type="button" id="add-education" class="mt-4 w-full text-blue-600 font-semibold py-2 px-4 border-2 border-dashed border-blue-300 rounded-md hover:bg-blue-50 transition duration-300">Add Education</button>
                </div>

                <!-- Languages Known -->
                <div class="bg-white p-4 rounded-lg border border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Languages Known</h3>
                    <div id="languages-list" class="space-y-2"></div>
                    <div class="flex flex-col sm:flex-row items-center mt-4 gap-2">
                        <input type="text" id="new-language" placeholder="Add a language" class="flex-grow w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <div id="new-language-rating" class="rating-stars flex items-center text-2xl">
                            <span class="star" data-value="1">☆</span>
                            <span class="star" data-value="2">☆</span>
                            <span class="star" data-value="3">☆</span>
                            <span class="star" data-value="4">☆</span>
                            <span class="star" data-value="5">☆</span>
                        </div>
                        <button type="button" id="add-language" class="w-full sm:w-auto bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700 transition duration-300">Add</button>
                    </div>
                </div>

                <!-- Declaration -->
                <div class="bg-white p-4 rounded-lg border border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Declaration</h3>
                    <textarea id="declaration" placeholder="e.g., I hereby declare that the information provided is true and correct." class="w-full h-24 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
            </form>
        </aside>

        <!-- Main Content - Resume Preview -->
        <main class="w-full md:w-1/2 lg:w-2/3 bg-gray-100 p-6 flex items-start justify-center overflow-y-auto">
            <div id="resume-preview-container" class="w-full max-w-4xl">
                 <div id="resume-preview" class="bg-white w-full text-gray-800">
                    <!-- Resume content will be injected here -->
                </div>
            </div>
        </main>
    </div>

    <!-- AI Assistant Floating Button -->
    <button id="ai-assistant-btn" class="no-print fixed bottom-6 right-6 bg-blue-600 text-white rounded-full p-4 shadow-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-transform duration-200 hover:scale-110">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
        </svg>
    </button>
    
    <!-- AI Assistant Modal -->
    <div id="ai-modal" class="hidden no-print fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
        <div class="relative mx-auto p-6 border w-full max-w-lg shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl leading-6 font-bold text-gray-900 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>
                        Stylize with AI
                    </h3>
                    <button id="ai-modal-close" class="text-gray-400 hover:text-gray-600">&times;</button>
                </div>
                <div class="text-left space-y-4">
                    <div>
                        <label for="ai-context" class="block text-sm font-medium text-gray-700">Select section to improve:</label>
                        <select id="ai-context" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md"></select>
                    </div>
                    <div>
                         <label for="ai-prompt" class="block text-sm font-medium text-gray-700">How can I help?</label>
                        <textarea id="ai-prompt" rows="3" class="mt-1 shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border-gray-300 rounded-md" placeholder="e.g., Make this more concise, or rewrite for a software engineer role..."></textarea>
                    </div>
                    <button id="ai-generate-btn" class="w-full inline-flex justify-center items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                         Generate
                    </button>
                </div>
                <div id="ai-result-container" class="mt-4 text-left">
                     <!-- Loading spinner -->
                    <div id="ai-loading" style="display: none;" class="flex justify-center items-center p-4">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                        <p class="ml-3 text-gray-600">Generating...</p>
                    </div>
                    <!-- Editable Result Preview -->
                    <textarea id="ai-result-preview" rows="6" class="shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border-gray-300 rounded-md bg-gray-50" style="display: none;"></textarea>
                    <div id="ai-actions" class="mt-2 flex gap-2" style="display: none;">
                       <button id="ai-copy-btn" class="flex-1 text-sm bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-1 px-3 rounded">Copy</button>
                       <button id="ai-insert-btn" class="flex-1 text-sm bg-blue-100 hover:bg-blue-200 text-blue-800 font-semibold py-1 px-3 rounded">Insert</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script type="module">
        import { GoogleGenAI } from 'https://esm.run/@google/genai';

        const app = {
            // --- STATE ---
            resumeData: {
                photo: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iI0U1RTdFQiI+PHBhdGggZmlsbC1ydWxlPSJldmVub2RkIiBkPSJNMTguNjg1IDE5LjA5N0E5LjcyMyA5LjcyMyAwIDAgMCAyMS43NSAxMmMwLTUuMzg1LTQuMzY1LTkuNzUtOS43NS05Ljc1UzIuMjUgNi42MTUgMi4yNSAxMmE5LjcyMyA5LjcyMyAwIDAgMCAzLjA2NSA3LjA5N0E5LjcxNiA5LjcxNiAwIDAgMCAxMiAyMS43NWE5LjcxNiA5LjcxNiAwIDAgMCA2LjY4NS0yLjY1M1ptLTEyLjU0LTEuMjg1QTcuNDg2IDcuNDg2IDAgMCAxIDEyIDE1YTcuNDg2IDcuNDg2IDAgMCAxIDUuODU1IDIuODEyQTguMjI0IDguMjI0IDAgMCAxIDEyIDIwLjI1YTguMjI0IDguMjI0IDAgMCAxLTUuODU1LTIuNDM4Wk0xNS43NSA5YTMuNzUgMy43NSAwIDEgMS03LjUgMCAzLjc1IDMuNzUgMCAwIDEgNy41IDBaIiBjbGlwLXJ1bGU9ImV2ZW5vZGQiIC8+PC9zdmc+',
                name: 'Your Name',
                jobTitle: 'Your Job Title',
                phone: '(123) 456-7890',
                email: 'your.email@example.com',
                address: '123 Main St, Anytown, USA',
                linkedin: 'linkedin.com/in/yourprofile',
                github: 'github.com/yourusername',
                portfolio: 'yourportfolio.com',
                summary: 'A brief and compelling summary of your professional background, skills, and career goals. Highlight your key achievements and expertise to capture the attention of recruiters.',
                experience: [
                    { id: Date.now() + 1, jobTitle: 'Senior Web Developer', company: 'Tech Solutions Inc.', dates: 'Jan 2020 - Present', description: '<li>Led front-end development for client projects.</li><li>Collaborated with UI/UX designers to create responsive and user-friendly interfaces.</li>' },
                    { id: Date.now() + 2, jobTitle: 'Junior Web Developer', company: 'Web Wizards', dates: 'Jun 2018 - Dec 2019', description: '<li>Assisted in the development and maintenance of websites.</li><li>Worked with HTML, CSS, JavaScript, and React.</li>' },
                ],
                education: [
                    { id: Date.now() + 3, degree: 'B.S. in Computer Science', school: 'University of Technology', dates: '2014 - 2018' }
                ],
                languages: [
                    { id: Date.now() + 4, name: 'English', level: 5 },
                    { id: Date.now() + 5, name: 'Spanish', level: 3 },
                ],
                declaration: 'I hereby declare that the information provided is true and correct.',
            },
            settings: {
                theme: 'Modern',
                font: "'Roboto', sans-serif",
                template: 'Professional',
                customStyles: {
                    textColor: '#333333',
                    highlightColor: '#e0f2fe',
                    fontSizeName: '36', // in px
                    fontSizeTitle: '20',
                    fontSizeSectionTitle: '18',
                    fontSizeBody: '11',
                }
            },
            ui: {
                currentLanguageRating: 0,
            },
            ai: {
                modalOpen: false,
                loading: false,
                context: '',
                prompt: '',
                result: '',
                client: null,
            },
            themes: {
                'Modern': '#2563eb', // blue
                'Classic': '#1f2937', // gray-800
                'Vibrant': '#db2777', // pink
                'Forest': '#166534', // green
                'Executive': '#1e3a8a', // dark blue
                'Creative': '#0d9488', // teal
            },
            fonts: {
                'Roboto': "'Roboto', sans-serif",
                'Open Sans': "'Open Sans', sans-serif",
                'Lato': "'Lato', sans-serif",
                'Montserrat': "'Montserrat', sans-serif",
                'Source Sans Pro': "'Source Sans Pro', sans-serif",
                'Merriweather': "'Merriweather', serif",
                'Playfair Display': "'Playfair Display', serif",
                'Poppins': "'Poppins', sans-serif",
            },
            templates: ['Professional', 'Compact', 'Modern', 'Creative', 'Technical', 'Minimalist', 'Timeline'],

            // --- INITIALIZATION ---
            init() {
                if (process.env.API_KEY) {
                    this.ai.client = new GoogleGenAI({ apiKey: process.env.API_KEY });
                } else {
                    console.warn("API_KEY environment variable not set. AI features will be disabled.");
                }
                this.loadState();
                this.cacheDOMElements();
                this.bindEvents();
                this.renderApp();
            },

            cacheDOMElements() {
                // Main elements
                this.form = document.getElementById('resume-form');
                this.preview = document.getElementById('resume-preview');
                this.downloadPdfBtn = document.getElementById('download-pdf-btn');
                
                // Form fields
                this.photoInput = document.getElementById('photo');
                this.photoPreview = document.getElementById('photo-preview');

                // Customization
                this.themeSelector = document.getElementById('theme-selector');
                this.fontSelect = document.getElementById('font-select');
                this.templateSelector = document.getElementById('template-selector');
                this.customStylesPanel = document.getElementById('custom-styles-panel');

                // Dynamic lists
                this.experienceList = document.getElementById('experience-list');
                this.educationList = document.getElementById('education-list');
                this.languagesList = document.getElementById('languages-list');
                this.newLanguageRatingContainer = document.getElementById('new-language-rating');

                // AI Assistant
                this.aiBtn = document.getElementById('ai-assistant-btn');
                this.aiModal = document.getElementById('ai-modal');
                this.aiModalCloseBtn = document.getElementById('ai-modal-close');
                this.aiContextSelect = document.getElementById('ai-context');
                this.aiPromptTextarea = document.getElementById('ai-prompt');
                this.aiGenerateBtn = document.getElementById('ai-generate-btn');
                this.aiResultContainer = document.getElementById('ai-result-container');
                this.aiLoading = document.getElementById('ai-loading');
                this.aiResultPreview = document.getElementById('ai-result-preview');
                this.aiActions = document.getElementById('ai-actions');
                this.aiCopyBtn = document.getElementById('ai-copy-btn');
                this.aiInsertBtn = document.getElementById('ai-insert-btn');
            },
            
            // --- EVENT BINDING ---
            bindEvents() {
                this.form.addEventListener('input', this.handleFormInput.bind(this));
                this.photoInput.addEventListener('change', this.handlePhotoUpload.bind(this));
                this.form.addEventListener('click', this.handleFormClicks.bind(this));
                this.newLanguageRatingContainer.addEventListener('click', this.handleLanguageRating.bind(this));
                
                // Customization events
                this.themeSelector.addEventListener('click', this.handleThemeChange.bind(this));
                this.fontSelect.addEventListener('change', this.handleFontChange.bind(this));
                this.templateSelector.addEventListener('click', this.handleTemplateChange.bind(this));
                this.customStylesPanel.addEventListener('input', this.handleCustomStyleChange.bind(this));
                this.downloadPdfBtn.addEventListener('click', this.handleDownloadPdf.bind(this));

                // AI events
                this.aiBtn.addEventListener('click', this.openAiModal.bind(this));
                this.aiModalCloseBtn.addEventListener('click', this.closeAiModal.bind(this));
                this.aiModal.addEventListener('click', (e) => {
                    if (e.target === this.aiModal) this.closeAiModal();
                });
                this.aiGenerateBtn.addEventListener('click', this.handleAiGenerate.bind(this));
                this.aiCopyBtn.addEventListener('click', this.handleAiCopy.bind(this));
                this.aiInsertBtn.addEventListener('click', this.handleAiInsert.bind(this));
            },

            // --- STATE MANAGEMENT ---
            updateState(key, value) {
                const keys = key.split('.');
                let current = this.resumeData;
                for (let i = 0; i < keys.length - 1; i++) {
                    current = current[keys[i]];
                }
                current[keys[keys.length - 1]] = value;
                this.renderPreview();
                this.saveState();
            },
            
            saveState() {
                const state = { resumeData: this.resumeData, settings: this.settings };
                localStorage.setItem('resumeState', JSON.stringify(state));
            },

            loadState() {
                const savedState = localStorage.getItem('resumeState');
                if (savedState) {
                    const parsedState = JSON.parse(savedState);
                    // Deep merge to handle nested objects like customStyles and languages array of objects
                    this.resumeData = { ...this.resumeData, ...parsedState.resumeData };
                    this.resumeData.experience = parsedState.resumeData.experience || [];
                    this.resumeData.education = parsedState.resumeData.education || [];
                    // Handle transition from string array to object array for languages
                    if (parsedState.resumeData.languages && typeof parsedState.resumeData.languages[0] === 'string') {
                        this.resumeData.languages = [
                            { id: Date.now() + 4, name: 'English', level: 5 },
                            { id: Date.now() + 5, name: 'Spanish', level: 3 },
                        ];
                    } else {
                        this.resumeData.languages = parsedState.resumeData.languages || [];
                    }
                    this.settings = { ...this.settings, ...parsedState.settings };
                    this.settings.customStyles = { ...app.settings.customStyles, ...(parsedState.settings.customStyles || {}) };
                }
            },

            // --- EVENT HANDLERS ---
            handleFormInput(e) {
                const target = e.target;
                if (target.id && this.resumeData.hasOwnProperty(target.id)) {
                    this.updateState(target.id, target.value);
                } else if (target.dataset.type && target.dataset.id && target.dataset.field) {
                    this.updateListItem(target);
                }
            },
            
            updateListItem(input) {
                const { type, id, field } = input.dataset;
                const list = this.resumeData[type];
                const itemIndex = list.findIndex(item => item.id == id);
                if (itemIndex > -1) {
                    let value = input.value;
                    if (field === 'description') {
                         value = value.split('\n')
                            .map(line => line.trim())
                            .filter(line => line)
                            .map(line => `<li>${line}</li>`)
                            .join('');
                    }
                    list[itemIndex][field] = value;
                    this.renderPreview(); // Only re-render preview for better performance
                    this.saveState();
                }
            },

            handlePhotoUpload(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        this.updateState('photo', event.target.result);
                    };
                    reader.readAsDataURL(file);
                }
            },
            
            handleFormClicks(e) {
                if (e.target.id === 'add-experience') this.addExperience();
                if (e.target.id === 'add-education') this.addEducation();
                if (e.target.id === 'add-language') this.addLanguage();
                if (e.target.matches('.remove-item-btn')) this.removeItem(e.target);
            },
            
            handleLanguageRating(e) {
                const star = e.target.closest('.star');
                if (!star) return;

                const rating = parseInt(star.dataset.value, 10);
                this.ui.currentLanguageRating = rating;
                
                Array.from(this.newLanguageRatingContainer.children).forEach((s, i) => {
                    s.classList.toggle('selected', i < rating);
                    s.innerHTML = i < rating ? '★' : '☆';
                });
            },

            handleThemeChange(e) {
                const card = e.target.closest('.theme-card');
                if (card && card.dataset.theme) {
                    this.settings.theme = card.dataset.theme;
                    this.renderApp();
                    this.saveState();
                }
            },

            handleFontChange(e) {
                this.settings.font = e.target.value;
                this.renderApp();
                this.saveState();
            },

            handleTemplateChange(e) {
                const card = e.target.closest('.template-card');
                if (card && card.dataset.template) {
                    this.settings.template = card.dataset.template;
                    this.renderApp();
                    this.saveState();
                }
            },
            
            handleCustomStyleChange(e) {
                const { style } = e.target.dataset;
                if (style && this.settings.customStyles.hasOwnProperty(style)) {
                    this.settings.customStyles[style] = e.target.value;
                    this.renderApp();
                    this.saveState();
                }
            },

            async handleDownloadPdf() {
                const button = this.downloadPdfBtn;
                const element = this.preview;
                const originalStyle = { ...element.style };
                
                button.disabled = true;
                button.textContent = 'Generating...';

                try {
                    Object.assign(element.style, {
                        width: '210mm', height: '297mm', margin: '0',
                        boxShadow: 'none', transform: 'none', padding: '0'
                    });

                    const opt = {
                        margin: 0, filename: 'resume.pdf',
                        image: { type: 'jpeg', quality: 0.98 },
                        html2canvas: { scale: 2, useCORS: true },
                        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                    };

                    await html2pdf().from(element).set(opt).save();
                } catch (error) {
                    console.error("PDF generation failed", error);
                    alert("Sorry, could not generate the PDF file.");
                } finally {
                    Object.assign(element.style, originalStyle);
                    button.disabled = false;
                    button.textContent = 'Download PDF';
                }
            },

            // --- CRUD for lists ---
            addExperience() {
                const newExp = { id: Date.now(), jobTitle: '', company: '', dates: '', description: '' };
                this.resumeData.experience.push(newExp);
                this.renderFormLists();
                this.saveState();
            },
            addEducation() {
                const newEdu = { id: Date.now(), degree: '', school: '', dates: '' };
                this.resumeData.education.push(newEdu);
                this.renderFormLists();
                this.saveState();
            },
            addLanguage() {
                const newLanguageInput = document.getElementById('new-language');
                const name = newLanguageInput.value.trim();
                const level = this.ui.currentLanguageRating;
                if (name && level > 0) {
                    const newLang = { id: Date.now(), name, level };
                    this.resumeData.languages.push(newLang);
                    
                    // Reset form
                    newLanguageInput.value = '';
                    this.ui.currentLanguageRating = 0;
                     Array.from(this.newLanguageRatingContainer.children).forEach(s => {
                        s.classList.remove('selected');
                        s.innerHTML = '☆';
                    });

                    this.renderFormLists();
                    this.renderPreview();
                    this.saveState();
                } else {
                    alert('Please enter a language and select a proficiency rating.');
                }
            },
            removeItem(button) {
                const { type, id } = button.dataset;
                this.resumeData[type] = this.resumeData[type].filter(item => item.id != id);
                this.renderFormLists();
                this.renderPreview();
                this.saveState();
            },
            
            // --- AI ASSISTANT LOGIC ---
            openAiModal() {
                if (!this.ai.client) {
                    alert("AI features are disabled. Please configure your API key.");
                    return;
                }
                this.ai.modalOpen = true;
                this.renderAiModal();
            },
            closeAiModal() {
                this.ai.modalOpen = false;
                this.ai.result = '';
                this.ai.prompt = '';
                this.ai.loading = false;
                this.renderAiModal();
            },
            async handleAiGenerate() {
                if (!this.ai.client) return;

                const userPrompt = this.aiPromptTextarea.value.trim();
                const contextId = this.aiContextSelect.value;
                const contextType = this.aiContextSelect.options[this.aiContextSelect.selectedIndex].text;
                
                if (!userPrompt) {
                    alert('Please enter a prompt.');
                    return;
                }

                this.ai.loading = true;
                this.ai.result = '';
                this.renderAiModal();

                let contextContent = '';
                const [type, id] = contextId.split('-');
                if (type === 'summary') {
                    contextContent = this.resumeData.summary;
                } else if (type === 'declaration') {
                    contextContent = this.resumeData.declaration;
                } else if (type === 'experience') {
                     const exp = this.resumeData.experience.find(item => item.id == id);
                     contextContent = exp.description.replace(/<li>/g, '').replace(/<\/li>/g, '\n').trim();
                }

                const systemInstruction = `You are an expert resume assistant. Rewrite or improve the provided resume content based on the user's specific instruction.
                Rules:
                1. Output ONLY the new, improved content. No conversational text or headings.
                2. If the original context is bullet points, format your response as a list of bullet points, one per line.
                3. If the context is a paragraph, output a paragraph.

                The context you are improving is for the section: "${contextType}".`;
                const fullPrompt = `Original Content:\n---\n${contextContent}\n---\n\nUser's Request: ${userPrompt}`;
                
                try {
                    const response = await this.ai.client.models.generateContent({
                        model: "gemini-2.5-flash",
                        contents: fullPrompt,
                        config: { systemInstruction: systemInstruction, temperature: 0.7 }
                    });
                    this.ai.result = response.text.trim();
                } catch (error) {
                    console.error("AI Generation Error:", error);
                    this.ai.result = "Sorry, something went wrong. Please check the console for details.";
                } finally {
                    this.ai.loading = false;
                    this.renderAiModal();
                }
            },
            handleAiCopy() {
                navigator.clipboard.writeText(this.aiResultPreview.value).then(() => {
                    this.aiCopyBtn.textContent = 'Copied!';
                    setTimeout(() => { this.aiCopyBtn.textContent = 'Copy'; }, 2000);
                });
            },
            handleAiInsert() {
                const contextId = this.aiContextSelect.value;
                const result = this.aiResultPreview.value;
                const [type, id] = contextId.split('-');

                if (type === 'summary') {
                    this.resumeData.summary = result;
                } else if (type === 'declaration') {
                    this.resumeData.declaration = result;
                } else if (type === 'experience') {
                    const expIndex = this.resumeData.experience.findIndex(item => item.id == id);
                    if (expIndex > -1) {
                         this.resumeData.experience[expIndex].description = result.split('\n')
                            .map(line => line.trim()).filter(line => line)
                            .map(line => `<li>${line}</li>`).join('');
                    }
                }
                this.renderApp();
                this.saveState();
                this.closeAiModal();
            },

            // --- UTILITY ---
            toTitleCase(str) {
                if (!str) return '';
                return str.replace(
                    /\w\S*/g,
                    (txt) => txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase()
                );
            },
            
            renderStars(level, color = '#f59e0b') {
                let stars = '';
                for (let i = 1; i <= 5; i++) {
                    stars += `<span style="color: ${i <= level ? color : '#d1d5db'}; font-size: 1.1em;">★</span>`;
                }
                return stars;
            },

            // --- RENDERING ---
            renderApp() {
                this.applyCustomStyles();
                this.populateForm();
                this.renderFormLists();
                this.renderPreview();
                this.renderAiModal();
            },
            
            populateForm() {
                ['name', 'jobTitle', 'phone', 'email', 'address', 'linkedin', 'github', 'portfolio', 'summary', 'declaration'].forEach(id => {
                    const el = document.getElementById(id);
                    if(el) el.value = this.resumeData[id] || '';
                });
                this.photoPreview.src = this.resumeData.photo;
                this.renderCustomizationPanel();
            },
            
            renderFormLists() {
                this.experienceList.innerHTML = this.resumeData.experience.map(exp => `
                    <div class="p-3 border border-gray-200 rounded-md bg-gray-50 relative space-y-2">
                        <button type="button" class="remove-item-btn absolute top-2 right-2 text-red-500 hover:text-red-700" data-type="experience" data-id="${exp.id}">&#x2715;</button>
                        <input type="text" data-type="experience" data-id="${exp.id}" data-field="jobTitle" value="${exp.jobTitle}" placeholder="Job Title" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                            <input type="text" data-type="experience" data-id="${exp.id}" data-field="company" value="${exp.company}" placeholder="Company" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <input type="text" data-type="experience" data-id="${exp.id}" data-field="dates" value="${exp.dates}" placeholder="Dates" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <textarea data-type="experience" data-id="${exp.id}" data-field="description" placeholder="Key responsibilities (one per line)" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">${exp.description.replace(/<li>/g, '').replace(/<\/li>/g, '\n').trim()}</textarea>
                    </div>`).join('');
                this.educationList.innerHTML = this.resumeData.education.map(edu => `
                     <div class="p-3 border border-gray-200 rounded-md bg-gray-50 relative space-y-2">
                        <button type="button" class="remove-item-btn absolute top-2 right-2 text-red-500 hover:text-red-700" data-type="education" data-id="${edu.id}">&#x2715;</button>
                        <input type="text" data-type="education" data-id="${edu.id}" data-field="degree" value="${edu.degree}" placeholder="Degree/Certification" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                            <input type="text" data-type="education" data-id="${edu.id}" data-field="school" value="${edu.school}" placeholder="Institution" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <input type="text" data-type="education" data-id="${edu.id}" data-field="dates" value="${edu.dates}" placeholder="Dates" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>`).join('');
                this.languagesList.innerHTML = this.resumeData.languages.map(lang => `
                    <div class="bg-blue-100 text-blue-800 text-sm font-medium px-3 py-2 rounded-md flex items-center justify-between">
                        <span>${lang.name}</span>
                        <div class="flex items-center">
                            <span class="mr-3">${this.renderStars(lang.level, this.themes[this.settings.theme] || '#2563eb')}</span>
                            <button type="button" class="remove-item-btn text-red-500 hover:text-red-700" data-type="languages" data-id="${lang.id}">&#x2715;</button>
                        </div>
                    </div>`).join('');
            },

            renderCustomizationPanel() {
                this.themeSelector.innerHTML = Object.entries(this.themes).map(([name, color]) => `
                    <div data-theme="${name}" class="theme-card cursor-pointer p-2 border rounded-lg flex flex-col items-center justify-center ${this.settings.theme === name ? 'selected' : ''}">
                        <div style="background-color: ${color}" class="w-full h-6 rounded-md mb-1"></div>
                        <span class="text-xs text-center">${name}</span>
                    </div>`).join('');
                this.fontSelect.innerHTML = Object.entries(this.fonts).map(([name, value]) => `
                    <option value="${value}" ${this.settings.font === value ? 'selected' : ''}>${name}</option>`).join('');
                this.templateSelector.innerHTML = this.templates.map(name => `
                    <div data-template="${name}" class="template-card cursor-pointer p-2 border rounded-lg flex flex-col items-center justify-center ${this.settings.template === name ? 'selected' : ''}">
                        <svg class="w-8 h-8 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m-5 4h4a2 2 0 002-2V6a2 2 0 00-2-2H9a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                        <span class="text-xs text-center mt-1">${name}</span>
                    </div>`).join('');
                
                // Set custom style input values
                for (const [key, value] of Object.entries(this.settings.customStyles)) {
                    const input = this.customStylesPanel.querySelector(`[data-style="${key}"]`);
                    if (input) {
                        input.value = value;
                        const valueDisplay = document.getElementById(`${input.id}-value`);
                        if (valueDisplay) {
                            valueDisplay.textContent = `${value}px`;
                        }
                    }
                }
            },
            
            applyCustomStyles() {
                const styles = this.settings.customStyles;
                this.preview.style.setProperty('--primary-color', this.themes[this.settings.theme]);
                this.preview.style.setProperty('--font-family', this.settings.font);
                this.preview.style.setProperty('--text-color', styles.textColor);
                this.preview.style.setProperty('--highlight-color', styles.highlightColor);
                this.preview.style.setProperty('--font-size-name', `${styles.fontSizeName}px`);
                this.preview.style.setProperty('--font-size-title', `${styles.fontSizeTitle}px`);
                this.preview.style.setProperty('--font-size-section-title', `${styles.fontSizeSectionTitle}px`);
                this.preview.style.setProperty('--font-size-body', `${styles.fontSizeBody}px`);
            },
            
            renderPreview() {
                const data = this.resumeData;
                
                const sectionTitle = (title) => `<h2 class="font-bold uppercase mt-4 pb-1 mb-2" style="font-size: var(--font-size-section-title); color: var(--primary-color); border-bottom: 2px solid var(--primary-color);">${title}</h2>`;
                const contactIcons = {
                    phone: `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" /></svg>`,
                    email: `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>`,
                    address: `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>`,
                    linkedin: `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 inline-block" viewBox="0 0 24 24" fill="currentColor"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 0 1-2.063-2.065 2.064 2.064 0 1 1 2.063 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.225 0z"></path></svg>`,
                    github: `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 inline-block" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg>`,
                    portfolio: `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg>`,
                };
                
                const createLink = (url, icon, type) => {
                    if (!url) return '';
                    const href = url.startsWith('http') ? url : `https://${url}`;
                    const displayUrl = url.replace(/^(https?:\/\/)?(www\.)?/, '');
                    return `<div class="flex items-center">${icon}<span><a href="${href}" target="_blank" rel="noopener noreferrer">${displayUrl}</a></span></div>`;
                };

                const expContent = data.experience.map(exp => `
                    <div class="mb-3 break-inside-avoid">
                        <div class="flex justify-between items-start">
                            <h3 class="font-bold" style="font-size: calc(var(--font-size-body) * 1.1);">${exp.jobTitle}</h3>
                            <span class="font-medium text-gray-500 text-right" style="font-size: calc(var(--font-size-body) * 0.9);">${exp.dates}</span>
                        </div>
                        <p class="italic mb-1" style="color: #4a5568; font-size: calc(var(--font-size-body) * 0.95);">${exp.company}</p>
                        <ul class="list-disc pl-5 space-y-0.5" style="font-size: var(--font-size-body);">${exp.description || ''}</ul>
                    </div>`).join('');
                const eduContent = data.education.map(edu => `
                    <div class="mb-3 break-inside-avoid">
                        <div class="flex justify-between items-start">
                            <h3 class="font-bold" style="font-size: calc(var(--font-size-body) * 1.1);">${edu.degree}</h3>
                            <span class="font-medium text-gray-500 text-right" style="font-size: calc(var(--font-size-body) * 0.9);">${edu.dates}</span>
                        </div>
                        <p style="color: #4a5568; font-size: calc(var(--font-size-body) * 0.95);">${edu.school}</p>
                    </div>`).join('');
                const languagesContent = `<div class="space-y-1">${data.languages.map(lang => `<div class="flex items-center justify-between" style="font-size: var(--font-size-body);"><span>${lang.name}</span><span>${this.renderStars(lang.level, 'var(--primary-color)')}</span></div>`).join('')}</div>`;
                const declarationContent = data.declaration ? `<div>${sectionTitle('Declaration')}<p style="font-size: var(--font-size-body);">${data.declaration}</p></div>` : '';
                const formattedName = this.toTitleCase(data.name);
                const signatureContent = `<div class="mt-4 text-right" style="page-break-inside: avoid;">
                                      <p class="w-48 inline-block border-t border-gray-700 pt-2 text-center" style="font-size: var(--font-size-body); font-style: italic;">${formattedName}</p>
                                  </div>`;


                let html = '';
                this.preview.style.padding = '2rem';
                
                switch (this.settings.template) {
                    case 'Compact':
                    case 'Modern':
                        this.preview.style.padding = '0';
                        const isModern = this.settings.template === 'Modern';
                        const modernLanguages = `<div class="space-y-1">${data.languages.map(lang => `<div class="flex items-center justify-between ${isModern ? 'opacity-90' : ''}" style="font-size: var(--font-size-body);"><span>${lang.name}</span><span>${this.renderStars(lang.level, isModern ? '#ffffff' : 'var(--primary-color)')}</span></div>`).join('')}</div>`;
                        const contactContentModern = `
                            <div class="space-y-1 ${isModern ? 'opacity-90' : ''}">
                                ${data.phone ? `<div>${contactIcons.phone} ${data.phone}</div>` : ''}
                                ${data.email ? `<div>${contactIcons.email} ${data.email}</div>` : ''}
                                ${data.address ? `<div>${contactIcons.address} ${data.address}</div>` : ''}
                                ${createLink(data.linkedin, contactIcons.linkedin)}
                                ${createLink(data.github, contactIcons.github)}
                                ${createLink(data.portfolio, contactIcons.portfolio)}
                            </div>`;

                        html = `
                            <div class="flex h-full" style="font-size: var(--font-size-body);">
                                <div class="w-1/3 p-6" style="background-color: ${isModern ? 'var(--primary-color)' : '#f4f4f4'}; color: ${isModern ? 'white' : 'var(--text-color)'};">
                                    <div class="h-24 w-24 rounded-full mb-4 mx-auto border-4 border-white shadow bg-center bg-cover" style="background-image: url('${data.photo}')"></div>
                                    <h1 class="font-bold mb-1 text-center" style="font-size: var(--font-size-name); color: ${isModern ? 'white' : 'var(--primary-color)'};">${data.name}</h1>
                                    <p class="font-medium mb-4 text-center ${isModern ? 'opacity-90' : 'text-gray-600'}" style="font-size: var(--font-size-title);">${data.jobTitle}</p>
                                    <h2 class="font-bold uppercase mt-4 pb-1 mb-2 border-b" style="font-size: var(--font-size-section-title); border-color:${isModern ? 'rgba(255,255,255,0.5)' : 'var(--primary-color)'};">Contact</h2>
                                    ${contactContentModern}
                                    <h2 class="font-bold uppercase mt-4 pb-1 mb-2 border-b" style="font-size: var(--font-size-section-title); border-color:${isModern ? 'rgba(255,255,255,0.5)' : 'var(--primary-color)'};">Languages Known</h2>
                                    ${modernLanguages}
                                </div>
                                <div class="w-2/3 p-6 border-l border-gray-200">
                                    ${sectionTitle('Profile')}<p class="mb-4">${data.summary}</p>
                                    ${sectionTitle('Work Experience')}${expContent}
                                    ${sectionTitle('Education')}${eduContent}
                                    ${declarationContent}
                                    ${signatureContent}
                                </div>
                            </div>`;
                        break;
                    case 'Creative':
                        this.preview.style.padding = '0';
                        const contactContentCreative = `
                            <div class="space-y-2" style="font-size: var(--font-size-body);">
                                ${data.phone ? `<div>${contactIcons.phone} ${data.phone}</div>` : ''}
                                ${data.email ? `<div>${contactIcons.email} ${data.email}</div>` : ''}
                                ${data.address ? `<div>${contactIcons.address} ${data.address}</div>` : ''}
                                ${createLink(data.linkedin, contactIcons.linkedin)}
                                ${createLink(data.github, contactIcons.github)}
                                ${createLink(data.portfolio, contactIcons.portfolio)}
                            </div>`;
                        html = `
                            <div class="h-full flex flex-col">
                                <header style="background-color: var(--primary-color);" class="p-8 text-white flex items-center space-x-6">
                                    <div class="w-28 h-28 rounded-full border-4 border-white shadow-lg bg-center bg-cover" style="background-image: url('${data.photo}')"></div>
                                    <div>
                                        <h1 class="font-bold tracking-wide" style="font-size: var(--font-size-name);">${data.name}</h1>
                                        <p class="opacity-90" style="font-size: var(--font-size-title);">${data.jobTitle}</p>
                                    </div>
                                </header>
                                <div class="p-8 flex-grow grid grid-cols-3 gap-8">
                                    <div class="col-span-1">
                                        <h2 class="font-bold mb-3" style="color:var(--primary-color); font-size: var(--font-size-section-title);">CONTACT</h2>
                                        ${contactContentCreative}
                                        <h2 class="font-bold mt-6 mb-3" style="color:var(--primary-color); font-size: var(--font-size-section-title);">LANGUAGES KNOWN</h2>
                                        ${languagesContent}
                                    </div>
                                    <div class="col-span-2 space-y-6">
                                        <div>${sectionTitle('Professional Summary')}<p style="font-size: var(--font-size-body);">${data.summary}</p></div>
                                        <div>${sectionTitle('Work Experience')}${expContent}</div>
                                        <div>${sectionTitle('Education')}${eduContent}</div>
                                        ${declarationContent}
                                        ${signatureContent}
                                    </div>
                                </div>
                            </div>`;
                        break;
                    case 'Technical':
                        this.preview.style.padding = '0';
                        const contactContentTechnical = `
                            <div class="text-center text-gray-500 border-y-2 py-2 mb-6 flex justify-around flex-wrap" style="font-size: calc(var(--font-size-body) * 0.9);">
                                ${data.phone ? `<span>${contactIcons.phone}${data.phone}</span>` : ''}
                                ${data.email ? `<span>${contactIcons.email}${data.email}</span>` : ''}
                                ${data.address ? `<span>${contactIcons.address}${data.address}</span>` : ''}
                                ${createLink(data.linkedin, contactIcons.linkedin)}
                                ${createLink(data.github, contactIcons.github)}
                                ${createLink(data.portfolio, contactIcons.portfolio)}
                            </div>`;
                        html = `
                            <div class="p-8 h-full flex flex-col">
                                 <header class="text-center mb-6">
                                    <h1 class="font-bold tracking-wider" style="color:var(--primary-color); font-size: var(--font-size-name);">${data.name}</h1>
                                    <p class="text-gray-600" style="font-size: var(--font-size-title);">${data.jobTitle}</p>
                                </header>
                                ${contactContentTechnical}
                                <main class="space-y-6 flex-grow">
                                    <div>${sectionTitle('Professional Summary')}<p style="font-size: var(--font-size-body);">${data.summary}</p></div>
                                    <div>${sectionTitle('Work Experience')}${expContent}</div>
                                    <div>${sectionTitle('Education')}${eduContent}</div>
                                    <div>${sectionTitle('Languages Known')}${languagesContent}</div>
                                    ${declarationContent}
                                    ${signatureContent}
                                </main>
                            </div>`;
                        break;
                    case 'Minimalist':
                         const contactContentMinimalist = `
                            <div class="flex justify-center flex-wrap gap-x-4 mt-2 text-gray-600" style="font-size: var(--font-size-body);">
                                ${data.phone ? `<span>${data.phone}</span>` : ''}
                                ${data.email ? `<span>&bull; ${data.email}</span>` : ''}
                                ${data.address ? `<span>&bull; ${data.address}</span>` : ''}
                            </div>
                            <div class="flex justify-center flex-wrap gap-x-4 mt-1 text-gray-600" style="font-size: var(--font-size-body);">
                                ${createLink(data.linkedin, contactIcons.linkedin)}
                                ${createLink(data.github, contactIcons.github)}
                                ${createLink(data.portfolio, contactIcons.portfolio)}
                            </div>`;

                        html = `
                            <div class="p-8">
                                <header class="text-center pb-6">
                                    <h1 class="font-bold" style="font-size: var(--font-size-name); color: var(--primary-color);">${data.name}</h1>
                                    <p class="font-medium" style="font-size: var(--font-size-title);">${data.jobTitle}</p>
                                    ${contactContentMinimalist}
                                </header>
                                <hr class="my-4">
                                ${sectionTitle('Profile')}<p class="mb-4" style="font-size: var(--font-size-body);">${data.summary}</p>
                                ${sectionTitle('Work Experience')}${expContent}
                                ${sectionTitle('Education')}${eduContent}
                                ${sectionTitle('Languages Known')}<div class="flex flex-wrap">${languagesContent}</div>
                                ${declarationContent}
                                ${signatureContent}
                            </div>`;
                        break;
                    case 'Timeline':
                        this.preview.style.padding = '0';
                        const timelineExp = data.experience.map((exp, index) => `
                            <div class="flex items-start ${index % 2 === 0 ? 'flex-row-reverse' : ''} mb-6">
                                <div class="w-1/2 px-4 text-sm ${index % 2 === 0 ? 'text-left' : 'text-right'}">
                                    <h3 class="font-bold">${exp.jobTitle}</h3>
                                    <p class="italic mb-1" style="color: #4a5568;">${exp.company}</p>
                                    <small class="text-gray-500">${exp.dates}</small>
                                </div>
                                <div class="w-px bg-gray-300 h-full relative">
                                    <div class="absolute w-3 h-3 rounded-full top-1 -ml-1" style="background-color: var(--primary-color);"></div>
                                </div>
                                <div class="w-1/2 px-4 text-sm">${index % 2 !== 0 ? exp.description.replace(/<ul/g, '<ul class="list-disc pl-5"').replace(/<\/li>/g, '</li><br>') : ''}</div>
                                ${index % 2 === 0 ? `<div class="w-1/2 px-4 text-sm">${exp.description.replace(/<ul/g, '<ul class="list-disc pl-5"').replace(/<\/li>/g, '</li><br>')}</div>` : ''}
                            </div>
                        `).join('');
                        const contactContentTimeline = `
                             <div class="flex justify-center flex-wrap gap-x-4 text-sm mt-2 text-gray-600" style="font-size: calc(var(--font-size-body) * 0.9);">
                                ${data.phone ? `<div class="flex items-center">${contactIcons.phone}<span>${data.phone}</span></div>` : ''}
                                ${data.email ? `<div class="flex items-center">${contactIcons.email}<span>${data.email}</span></div>` : ''}
                                ${data.address ? `<div class="flex items-center">${contactIcons.address}<span>${data.address}</span></div>` : ''}
                                ${createLink(data.linkedin, contactIcons.linkedin)}
                                ${createLink(data.github, contactIcons.github)}
                                ${createLink(data.portfolio, contactIcons.portfolio)}
                            </div>`;
                        html = `
                            <div class="p-8">
                                <header class="text-center mb-8">
                                    <h1 class="font-bold" style="font-size: var(--font-size-name); color: var(--primary-color);">${data.name}</h1>
                                    <p class="font-medium" style="font-size: var(--font-size-title);">${data.jobTitle}</p>
                                    ${contactContentTimeline}
                                </header>
                                ${sectionTitle('Work Experience')}
                                <div class="mt-4" style="font-size: var(--font-size-body);">${timelineExp}</div>
                                <div class="grid grid-cols-2 gap-8 mt-8">
                                    <div>${sectionTitle('Education')}${eduContent}</div>
                                    <div>${sectionTitle('Languages Known')}${languagesContent}</div>
                                </div>
                                <div class="mt-8">${declarationContent}${signatureContent}</div>
                            </div>`;
                        break;
                    default: // Professional
                        const contactContentProfessional = `
                            <div class="flex justify-center flex-wrap gap-x-4 text-sm mt-2 text-gray-600" style="font-size: calc(var(--font-size-body) * 0.9);">
                                ${data.phone ? `<div class="flex items-center">${contactIcons.phone}<span>${data.phone}</span></div>` : ''}
                                ${data.email ? `<div class="flex items-center">${contactIcons.email}<span>${data.email}</span></div>` : ''}
                                ${data.address ? `<div class="flex items-center">${contactIcons.address}<span>${data.address}</span></div>` : ''}
                                ${createLink(data.linkedin, contactIcons.linkedin)}
                                ${createLink(data.github, contactIcons.github)}
                                ${createLink(data.portfolio, contactIcons.portfolio)}
                            </div>`;
                         html = `
                            <div>
                                <header class="text-center pb-4 mb-4 border-b-2" style="border-bottom-color: var(--primary-color);">
                                    <h1 class="font-extrabold mb-1" style="color: var(--primary-color); font-size: var(--font-size-name);">${data.name}</h1>
                                    <p class="font-semibold text-gray-600" style="font-size: var(--font-size-title);">${data.jobTitle}</p>
                                    ${contactContentProfessional}
                                </header>
                                ${sectionTitle('Professional Summary')}<p class="mb-4" style="font-size: var(--font-size-body);">${data.summary}</p>
                                ${sectionTitle('Work Experience')}${expContent}
                                ${sectionTitle('Education')}${eduContent}
                                ${sectionTitle('Languages Known')}<div class="flex flex-wrap">${languagesContent}</div>
                                ${declarationContent}
                                ${signatureContent}
                            </div>`;
                }
                this.preview.innerHTML = html;
            },
            
            renderAiModal() {
                 if (this.ai.modalOpen) {
                    this.aiModal.classList.remove('hidden');
                    let options = `<option value="summary">Professional Summary</option>`;
                    options += `<option value="declaration">Declaration</option>`;
                    this.resumeData.experience.forEach((exp) => {
                        options += `<option value="experience-${exp.id}">Experience: ${exp.jobTitle || 'Untitled'}</option>`;
                    });
                    this.aiContextSelect.innerHTML = options;
                } else {
                    this.aiModal.classList.add('hidden');
                }

                this.aiLoading.style.display = this.ai.loading ? 'flex' : 'none';
                this.aiGenerateBtn.disabled = this.ai.loading;
                this.aiGenerateBtn.textContent = this.ai.loading ? 'Generating...' : 'Generate';
                this.aiResultPreview.style.display = this.ai.result ? 'block' : 'none';
                this.aiActions.style.display = this.ai.result ? 'flex' : 'none';
                this.aiResultPreview.value = this.ai.result;
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });
        window.app = app;
    </script>
</body>
</html>